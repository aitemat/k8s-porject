# Tổng quan
## iSCSI là gì?
`Persistent Volume (PV)` trong Kubernetes là một tài nguyên cấp cao, đại diện cho một phần trữ lượng lưu trữ bên ngoài được cung cấp cho các container trong cluster. PV giúp cho việc quản lý và sử dụng các tài nguyên lưu trữ trở nên dễ dàng và linh hoạt hơn.

`iSCSI` (Internet Small Computer System Interface) là một giao thức lưu trữ cho phép máy chủ kết nối đến các thiết bị lưu trữ thông qua mạng IP. Trong Kubernetes, iSCSI được sử dụng để kết nối đến các thiết bị lưu trữ bên ngoài, chia sẻ các tài nguyên lưu trữ đó với các container trong cluster.

Các bước để sử dụng Persistent Volume với iSCSI trong Kubernetes bao gồm:

- Cấu hình iSCSI target trên máy chủ lưu trữ (storage server).

- Cài đặt iSCSI initiator trên các node trong Kubernetes cluster để kết nối đến iSCSI target.

- Tạo một Persistent Volume (PV) trong Kubernetes cluster để đại diện cho phần trữ lượng lưu trữ bên ngoài được cung cấp thông qua iSCSI. PV có thể được định nghĩa thông qua các thông số như địa chỉ IP của iSCSI target, tên iSCSI target, tên iSCSI phân vùng, dung lượng lưu trữ, và quyền truy cập.

- Tạo một Persistent Volume Claim (PVC) trong Kubernetes cluster để yêu cầu sử dụng một phần hoặc toàn bộ dung lượng của PV.

- Sử dụng PVC trong Pod bằng cách sử dụng đối tượng VolumeClaimTemplate trong file định nghĩa Pod. Khi Pod được tạo, Kubernetes sẽ tự động cung cấp một phiên bản của PV được yêu cầu thông qua PVC.

Khi một container được triển khai trên Kubernetes cluster, Kubernetes sẽ liên kết các PVC được sử dụng trong Pod với PV tương ứng để cung cấp truy cập đến các tài nguyên lưu trữ bên ngoài được cung cấp thông qua iSCSI. Khi container bị xóa hoặc di chuyển, Kubernetes sẽ tự động giải phóng các tài nguyên lưu trữ bên ngoài bằng cách giải phóng các PVC và PV được sử dụng trong Pod. 
## Một số thuật ngữ

+ `iSCSI Target Server`: Server quản lý các thiết bị lưu trữ.

+ `Physical Disk`: Đĩa vật lý. Thông thường 1 iSCSI Target Server phải gắn nhiều đĩa vật lý.

+ `iSCSI Virtual Disk`: Là các đĩa ảo được tạo ra từ 1 Physical Disk.

+ `iSCSI Target`: Là tập hợp gồm 1 hoặc nhiều iSCSI Virtual Disk để các Server có thể kết nối đến và sử dụng.

+ `iSCSI Initiator (Access Server)`: là 1 Server đảm nhận một dịch vụ bất kỳ mà nó sẽ kết nối tới iSCSI Target để sử dụng hệ thống đĩa.

+ `Storage Pool`: là tập hợp các iSCSI Virtual Disk đã kết nối được từ iSCSI Target mà chúng ta muốn sử dụng.

+ `Virtual Disk`: là 1 đĩa cứng ảo, dùng để xác định mục đích sử dụng.

+ `Volume`: là ổ đĩa luận lý được gán ký tự đĩa và được sử dụng để lưu trữ dữ liệu cho server
## Các bước triển khai cài đặt iSCSI
- Cài đặt iSCSI Target Server

- Tạo iSCSI Virtual Disk

- Kết nối đến iSCSI Target

- Tạo Storage Pool

- Tạo Virtual Disk

- Tạo Volume

- Kiểm tra
# 1. Requirement
`Master 1`: Docker + Master node (RAM >=3GB + CPU 4 + Disk >=30GB: 45.117.80.52 - Ubuntu 20.04 - hostname: k8s-master1  
`Master 2`: Docker + Master node (RAM >=3GB + CPU 4 + Disk >=30GB: 103.101.162.200 - Ubuntu 20.04 - hostname: k8s-master2  
`Master 3`: Docker + Master node (RAM >=3GB + CPU 4 + Disk >=30GB: 45.117.80.150 - Ubuntu 20.04 - hostname: k8s-master3- Haproxy  
`Master 4`: Window server 2022 (RAM >=3GB + CPU 4 + Disk >=40GB): 103.101.162.145 - iSCSI server   
`Node 1`: Docker + Node worker 1 ( RAM 2GB + CPU 1 + Disk 20GB): 103.101.163.72 - Ubuntu 20.04 - hostname: k8s-nodew1  
`Node 2`: Docker + Node worker 2 ( RAM 2GB + CPU 1 + Disk 20GB): 103.101.162.20 - Ubuntu 20.04 - hostname: k8s-nodew1  

# 2. Cài đặt và cấu hình iSCSI target trên window server 2022 (Master 4)
## a. Cài đặt iSCSI target
**B1:** Mở Server Manager, vào menu Manage, chọn Add Roles and Features.  
<img src="/images/iscsi1.jpg">  
**B2:** Cửa sổ Before You Begin, chọn Next 3 lần.  
**B3:** Cửa sổ Select server roles, bung mục File and Storage services, đánh dấu chọn iSCSI Target Server, chọn Add Features, sau đó chọn Next 2 lần  

<img src="/images/iscsi2.jpg"> 

**B4:** Cửa sổ Confirm installation selections, chọn Install, chọn Close.  

<img src="/images/iscsi3.jpg">  

<img src="/images/iscsi4.jpg"> 

## b. Cấu hình iSCSI
B1 - Vào Server Manager, chọn `File and Storage Services` ở khung bên trái. Tiếp theo chọn iSCSI, chọn liên kết `start the New iSCSI Virtual Disk Wizard`.  

<img src="/images/iscsi5.jpg"> 

B2 - Cửa sổ Select `iSCSI virtual disk location`, ở mục `Select by volume`, chọn vào phân vùng cần tạo `iSCSI Virtual Disk` (trong bài lab này sẽ tạo Disk1 từ ổ đĩa C), chọn Next.  

<img src="/images/iscsi6.jpg"> 

B3 - Cửa sổ `Specify iSCSI virtual disk name`, nhập `disk-share1` vào ô Name và chọn Next.  

<img src="/images/iscsi7.jpg"> 

B4 – Cửa sổ Specify iSCSI virtual disk size, nhập 10 GB vào ô Size, và chọn Next.

<img src="/images/iscsi8.jpg">

B5 – Cửa sổ Assign iSCSI target, chọn New iSCSI target, và chọn Next.  

<img src="/images/iscsi9.jpg"> 

B6 – Cửa sổ Specify target name, nhập target1 vào ô Name, và chọn Next.  

<img src="/images/iscsi10.jpg"> 

B7 – Cửa sổ Specify access servers, chọn Add để thêm vào máy Server sẽ kết nối đến iSCSI Target nhằm mục đích sử dụng hệ thống đĩa.  
B8 – Cửa sổ Add initiator ID, chọn Enter a value for the selected type, bung ô Type, chọn IP Address, nhập IP tất cả các node cần sử dụng trong mô hình vào ô Value và chọn OK. 

<img src="/images/iscsi11.jpg"> 

B9 – Cửa sổ Specify access servers, chọn Next.  
B10 – Cửa sổ Enable Authentication, chọn Next (trong lab này sẽ chọn bỏ qua authen)

<img src="/images/iscsi12.jpg"> 

B11 – Cửa sổ Confirm Selections, chọn Create.  

<img src="/images/iscsi13.jpg"> 

B12 – Cửa sổ View Results, chọn Close.  

<img src="/images/iscsi14.jpg"> 

# 3. Kết nối qua iSCSI Initiator
Trong mô hình này ta sẽ dùng Master3 làm node mount storage
## Cài đặt gói iSCSI Initiator
`sudo apt-get install open-iscsi`  
## Cấu hình kết nối
Sử dụng lệnh sau để thêm iSCSI target:
`sudo iscsiadm -m discovery -t st -p 103.101.162.145`  
Trong đó:  
- `103.101.162.145`: là iSCSI server  

Khi bạn nhập lệnh trên, iSCSI Initiator sẽ tìm kiếm iSCSI target trên máy chủ iSCSI và hiển thị danh sách các iSCSI target đã được tìm thấy.  
Chạy 3 lệnh sau trên các node worker và master:  
`sudo iscsiadm -m node -o new -T iqn.1991-05.com.microsoft:k8s-iscsi-targe-target1-target -p 103.101.162.145`  
Lệnh này tạo một kết nối mới đến iSCSI target có địa chỉ IP là 103.101.162.145 và tên là iqn.1991-05.com.microsoft:k8s-iscsi-targe-target1-target  
`sudo iscsiadm -m node -o update -T iqn.1991-05.com.microsoft:k8s-iscsi-targe-target1-target -p 103.101.162.145 -n node.startup -v automatic` 
Lệnh này cập nhật cấu hình của iSCSI target đã được tạo trước đó. Nó đặt giá trị của thuộc tính node.startup thành automatic, có nghĩa là iSCSI target sẽ được tự động kết nối khi máy chủ khởi động.  
`sudo iscsiadm -m node -T iqn.1991-05.com.microsoft:k8s-iscsi-targe-target1-target -p 103.101.162.145 -l` 
Lệnh này kết nối đến iSCSI target đã được tạo trước đó bằng cách sử dụng địa chỉ IP và tên của nó. Khi kết nối thành công, iSCSI target sẽ được hiển thị như một thiết bị lưu trữ trên máy chủ.  

# 4. Triển khai app trên Master1 
## Random số lượng pod chia đều cho các node worker
Viết 1 file `deploy_iscsi.yaml` :
```sh
apiVersion: v1
kind: PersistentVolume
metadata:
  name: pv-10g
spec:
  capacity:
    storage: 10Gi
  accessModes:
    - ReadWriteMany
  iscsi:
    targetPortal: 103.101.162.145:3260  # IP port iSCSI server
    iqn: iqn.1991-05.com.microsoft:k8s-iscsi-targe-target1-target  # iSCSI target đã triển khai trên window server 2022
    lun: 0
    fsType: ext4
    readOnly: false
  persistentVolumeReclaimPolicy: Retain

---

apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: pvc-10g
spec:
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 10Gi

---

apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx
spec:
  replicas: 2
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx
        volumeMounts:
        - name: iscsi-volume
          mountPath: /usr/share/nginx/html   # thư mục web của service nginx
      volumes:
      - name: iscsi-volume
      volumes:
      - name: iscsi-volume
        persistentVolumeClaim:
          claimName: pvc-10g  # pod sử dụng storage của pvc-10g

---
apiVersion: v1
kind: Service
metadata:
  name: nginx-service
spec:
  type: NodePort
  ports:
    - name: nginx
      nodePort: 30070  # port public đễ bên ngoài truy cập
      port: 80
      protocol: TCP
      targetPort: 80
  selector:
    app: nginx

```
Chạy lệnh trên đễ tạo PV, PVC, deployment, pod và public service qua nodeport.  

<img src="/images/iscsi15.jpg">  

Trong đó ta thấy khi sử dụng replicas=2 thì pod sẽ chia đều cho 2 node worker: 

<img src="/images/iscsi16.jpg">  

<img src="/images/iscsi17.jpg">  

## Gán cố định pod cho 1 node worker
Viết 1 file `deploy_iscsi.yaml` :









