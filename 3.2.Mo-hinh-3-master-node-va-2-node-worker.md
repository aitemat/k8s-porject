# Requirement
- OS: Ubuntu 20.04  
- 3 Máy chủ Ubuntu 20 làm Master  
- 2 máy chủ ubuntu 20 làm worker  
- 5 máy đều kết nối internet  
- k8s-master1 : 10.0.0.6 - Master làm nhiệm vụ cluster cho các master và worker kết nối vào.  
- k8s-master2: 10.0.0.7  
- k8s-master3: 10.0.0.8  
- k8s-node1: 10.0.0.10  
- k8s-node2: 10.0.0.  
# Cài đặt các config cơ bản cho tất cả các node master và worker
## Add host cho tất cả các node hiểu nhau:  
`vi /etc/hosts`  
Nội dung:  
```sh
10.0.0.6 k8s-master1
10.0.0.7 k8s-master2
10.0.0.8 k8s-master3
10.0.0.10 k8s-node1
10.0.0. k8s-node2
```
## Đặt IP tĩnh lần lượt cho 5 node
`vi etc/netplan/00-installer-config.yaml`  
Chỉnh sửa nội dung:  
```sh
network:
  ethernets:
    ens33:
      dhcp4: no
      dhcp6: no
      addresses: [10.0.0.7/16] #tại đây đổi thành IP cần đặt
      gateway4: 10.0.0.1
      nameservers:
         addresses: [8.8.8.8, 8.8.4.4]
  version: 2
```
## 1. Cài đặt docker trên tất cả các node
Cài đặt Docker trên các máy chủ bằng các lệnh sau:  
```sh
sudo apt-get update
sudo apt-get install -y docker.io
sudo systemctl enable docker
sudo systemctl start docker

```
## 2.Cài đặt Kubernetes trên 5 node bằng các lệnh sau:
```sh
sudo apt-get update && sudo apt-get install -y apt-transport-https curl
curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add -
sudo touch /etc/apt/sources.list.d/kubernetes.list 
echo "deb https://apt.kubernetes.io/ kubernetes-xenial main" | sudo tee -a /etc/apt/sources.list.d/kubernetes.list 
sudo apt-get update 
sudo apt-get install -y kubelet kubeadm kubectl
sudo apt-mark hold kubelet kubeadm kubectl
```
## 3. Khởi tạo cluster trên node master đầu tiên bằng lệnh sau:
`sudo kubeadm init --control-plane-endpoint="<load-balancer-IP>:6443" --upload-certs --pod-network-cidr=<pod-network-cidr>`  
Trong đó:
- `<load-balancer-IP>` là địa chỉ IP của load balancer nếu bạn sử dụng load balancer, hoặc là địa chỉ IP của node master đầu tiên nếu bạn không sử dụng load balancer. 
- `<pod-network-cidr>` là địa chỉ CIDR cho mạng pod, ví dụ: 192.168.0.0/16.  
Sau khi khởi tạo thành công, lưu lại giá trị token và certificate hash được hiển thị trên màn hình.  
Sinh ra 2 cặp lệnh:  

Lệnh dùng join node worker:  
```sh
kubeadm join 10.0.0.6:6443 --token t37lhe.j9z8hvop9hmzp2mq \
        --discovery-token-ca-cert-hash sha256:de9ee8be7dbe5d9ee3d7eff51b03e10f51d445de1ed7ced415d7b70d82a9581e
```
Lệnh dùng cho node master join vào:  
```sh
 kubeadm join 10.0.0.6:6443 --token t37lhe.j9z8hvop9hmzp2mq \
        --discovery-token-ca-cert-hash sha256:de9ee8be7dbe5d9ee3d7eff51b03e10f51d445de1ed7ced415d7b70d82a9581e \
        --control-plane --certificate-key f9a58b5455236ec016332716d6ca317d30c3eddb6e420664d613933794969005
```
### Cấu hình `kubectl` trên một node Kubernetes (thực hiện trên 3 master)
`mkdir -p $HOME/.kube`  
`sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config`  
`sudo chown $(id -u):$(id -g) $HOME/.kube/config`  
`export KUBECONFIG=/etc/kubernetes/admin.conf`  
`echo "source <(kubectl completion bash)" >> ~/.bashrc`  
### Cài đặt Pod network (thực hiện trên 3 master)
`sudo kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml`  
Lệnh kiểm tra:  
`kubectl get pods --all-namespaces`
## 4. Trên các node master tiếp theo, sử dụng lệnh sau để tham gia vào cluster
`sudo kubeadm join <load-balancer-IP>:6443 --token <token-value> --discovery-token-ca-cert-hash sha256:<hash-value> --control-plane --certificate-key <certificate-key-value>`  
Trong đó:  
`<load-balancer-IP>` là địa chỉ IP của load balancer nếu bạn sử dụng load balancer, hoặc là địa chỉ IP của node master đầu tiên nếu bạn không sử dụng load balancer.  
`<token-value>` và `<hash-value>` là giá trị token và certificate hash đã được lưu lại ở bước trước.  
`<certificate-key-value>` là giá trị certificate key cũng được hiển.  
Sau khi chạy lệnh trên ta chạy thêm các lệnh sau trong master k8s-master2 và k8s-master3:  
```sh
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
```
Lệnh trên được sử dụng để sao chép tệp cấu hình của Kubernetes và phân quyền cho người dùng hiện tại để truy cập vào tệp cấu hình đó. Cụ thể, nó thực hiện các bước sau:

Tạo thư mục .kube trong thư mục home của người dùng hiện tại bằng lệnh mkdir -p $HOME/.kube. Nếu thư mục này không tồn tại, nó sẽ được tạo mới.

Sao chép tệp cấu hình của Kubernetes từ đường dẫn /etc/kubernetes/admin.conf đến thư mục $HOME/.kube/config bằng lệnh sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config. Điều này đảm bảo rằng người dùng hiện tại có thể truy cập vào tệp cấu hình của Kubernetes.

Phân quyền cho người dùng hiện tại để truy cập vào tệp cấu hình bằng lệnh sudo chown $(id -u):$(id -g) $HOME/.kube/config. Điều này đảm bảo rằng người dùng hiện tại có quyền truy cập vào tệp cấu hình của Kubernetes.

Sau khi thực hiện các bước trên, người dùng hiện tại có thể sử dụng lệnh kubectl để truy cập và quản lý cụm Kubernetes.
## 5. Sau khi các node master đã tham gia vào cluster, sử dụng lệnh sau để thêm các node worker vào cluster
`sudo kubeadm join <load-balancer-IP>:6443 --token <token-value> --discovery-token-ca-cert-hash sha256:<hash-value>`  
Trong đó:  
`<load-balancer-IP>` là địa chỉ IP của load balancer nếu bạn sử dụng load balancer, hoặc là địa chỉ IP của node master đầu tiên nếu bạn không sử dụng load balancer.  
`<token-value>` và `<hash-value>` là giá trị token và certificate hash đã được lưu lại ở bước trước.  
## 6. Sau khi tất cả các node đã tham gia vào cluster, bạn có thể kiểm tra trạng thái của cluster bằng lệnh sau trên node master đầu tiên
`kubectl get nodes`  
Nếu tất cả các node đều hiển thị là Ready, có nghĩa là cluster đã được triển khai thành công.  
Chú ý: Việc triển khai một cluster Kubernetes với 3 node master và 2 node worker chỉ là một cấu hình cơ bản. Tùy thuộc vào nhu cầu sử dụng và môi trường cụ thể, bạn có thể điều chỉnh số lượng và cấu hình của các node để phù hợp hơn.


