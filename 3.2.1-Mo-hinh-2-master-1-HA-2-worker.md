# Requirement
- OS: Ubuntu 20.04  
- 3 Máy chủ Ubuntu 20 làm Master  
- 2 máy chủ ubuntu 20 làm worker  
- 5 máy đều kết nối internet  
103.170.123.17 lab-k8m1 : Master chính
103.124.92.123 lab-k8m2 : Master phụ
103.124.94.2 lab-k8lb : HAProxy
103.159.50.124 lab-k8w1: Node Worker
103.170.123.58 lab-k8w2: Node Worker
# Cài đặt các config cơ bản cho tất cả các node master và worker
## Add host cho tất cả các node hiểu nhau:  
`vi /etc/hosts`  
Nội dung:  
```sh
103.170.123.17 lab-k8m1
103.124.92.123 lab-k8m2
103.124.94.2 lab-k8lb
103.159.50.124 lab-k8w1
103.170.123.58 lab-k8w2
```
## Đặt IP tĩnh (chỉ đặt trong trường hợp máy ảo không thể tự cấp phát IP tĩnh)
`vi etc/netplan/00-installer-config.yaml`  
Chỉnh sửa nội dung:  
```sh
network:
  ethernets:
    ens33:
      dhcp4: no
      dhcp6: no
      addresses: [10.0.0.7/16] #tại đây đổi thành IP cần đặt
      gateway4: 10.0.0.1 # đổi gateway IP mạng
      nameservers:
         addresses: [8.8.8.8, 8.8.4.4]
  version: 2
```

# Cài đặt HAProxy trên k8s-master3 (Master làm load balance)
Chạy lệnh cài đặt HAproxy: ` apt-get install haproxy -y`  
Sau khi cài đặt xong tiến hành edit file config Haproxy: `vi /etc/haproxy/haproxy.cfg`  
Thêm vào cuối nội dung:  
```sh
frontend kubernetes
  bind 103.124.94.2:6443
  mode tcp
  option tcplog
  default_backend kubernetes-master-nodes

backend kubernetes-master-nodes
  mode tcp
  option tcp-check
  balance roundrobin
  server lab-k8m1 103.170.123.17:6443 check fall 3 rise 2
  server lab-k8m2 103.124.92.123:6443 check fall 3 rise 2

listen stats
    bind 103.124.94.2:8080
    mode http
    stats enable
    stats uri /
    stats realm HAProxy\ Statistics
    stats auth admin:haproxy
```  
Sau đó restart dịch vụ đễ apply cấu hình:  `systemctl status haproxy`  
Link truy cập Haproxy: http://103.124.94.2:8080/Statistics

<img src="/images/haproxy.jpg">
